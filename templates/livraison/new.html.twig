{% extends 'admin/base.html.twig' %}

                         {% block admin_title %}Create New Delivery{% endblock %}

                         {% block admin_content %}
                             <div class="container-fluid">
                                 <h1 class="h3 mb-4">Create New Delivery</h1>

                                 <div class="card shadow">
                                     <div class="card-body">
                                         {{ form_start(form, {'attr': {'novalidate': 'novalidate'}}) }}

                                         {{ form_row(form.startLocation) }}
                                         {{ form_row(form.deliveryLocation) }}
                                         {{ form_row(form.isDelivered) }}

                                         <hr>
                                         <fieldset class="mb-3">
                                             <legend>{{ form_label(form.packages) }}</legend>
                                             <div id="packages-wrapper"
                                                  class="packages-collection mb-2"
                                                  data-index="{{ form.packages|length > 0 ? form.packages|last.vars.name + 1 : 0 }}"
                                                  data-prototype="{{ form_widget(form.packages.vars.prototype)|e('html_attr') }}"
                                             >
                                                 {% for packageForm in form.packages %}
                                                     <div class="package-entry border p-2 mb-2 rounded bg-light">
                                                         <h6 class="package-entry-label">Package #{{ loop.index }}</h6>
                                                         {{ form_errors(packageForm) }}
                                                         {{ form_row(packageForm.weightPackage) }}
                                                         {{ form_row(packageForm.descriptionPackage) }}
                                                         <button type="button" class="btn btn-danger btn-sm remove-package-button mt-2">
                                                             <i class="fas fa-trash"></i> Remove Package
                                                         </button>
                                                         <hr>
                                                     </div>
                                                 {% endfor %}
                                             </div>
                                             <button type="button" id="add-package-button" class="btn btn-secondary btn-sm add_item_link">
                                                 <i class="fas fa-plus"></i> Add Package
                                             </button>
                                         </fieldset>

                                         <div class="mt-4">
                                             <button class="btn btn-success">
                                                 <i class="fas fa-save"></i> Save Delivery
                                             </button>
                                             <a href="{{ path('app_admin_livraison_index') }}" class="btn btn-secondary">
                                                 <i class="fas fa-arrow-left"></i> Back to list
                                             </a>
                                         </div>

                                         {{ form_end(form) }}
                                     </div>
                                 </div>
                             </div>
                         {% endblock %}

                         {% block javascripts %}
                             {{ parent() }}
                             <script>
                                 document.addEventListener('DOMContentLoaded', () => {
                                     const addPackageButton = document.getElementById('add-package-button');
                                     const packagesWrapper = document.getElementById('packages-wrapper');

                                     const addRemoveListener = (entryDiv) => {
                                         const removeButton = entryDiv.querySelector('.remove-package-button');
                                         if (removeButton) {
                                             removeButton.addEventListener('click', (e) => {
                                                 e.preventDefault();
                                                 entryDiv.remove();
                                             });
                                         }
                                     };

                                     if (addPackageButton && packagesWrapper) {
                                         addPackageButton.addEventListener('click', (e) => {
                                             e.preventDefault();
                                             let index = parseInt(packagesWrapper.dataset.index || '0');
                                             const prototype = packagesWrapper.dataset.prototype;
                                             const newFormHtml = prototype.replace(/__name__/g, index);
                                             const newEntryDiv = document.createElement('div');
                                             newEntryDiv.classList.add('package-entry', 'border', 'p-2', 'mb-2', 'rounded', 'bg-light');
                                             newEntryDiv.innerHTML = newFormHtml;
                                             const removeButton = document.createElement('button');
                                             removeButton.type = 'button';
                                             removeButton.innerHTML = '<i class="fas fa-trash"></i> Remove Package';
                                             removeButton.classList.add('btn', 'btn-danger', 'btn-sm', 'remove-package-button', 'mt-2');
                                             newEntryDiv.appendChild(document.createElement('hr'));
                                             newEntryDiv.appendChild(removeButton);
                                             addRemoveListener(newEntryDiv);
                                             packagesWrapper.appendChild(newEntryDiv);
                                             packagesWrapper.dataset.index = index + 1;
                                         });
                                     }

                                     packagesWrapper.querySelectorAll('.package-entry').forEach(entry => {
                                         addRemoveListener(entry);
                                     });
                                 });
                             </script>
                         {% endblock %}