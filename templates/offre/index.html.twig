{% extends 'admin/base.html.twig' %}

{% block admin_title %}Manage Offres{% endblock %}

{% block admin_content %}
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">Manage Offres</h1>
            <a href="{{ path('app_offre_new') }}" class="btn btn-success">
                <i class="fas fa-plus"></i> Create New Offre
            </a>
        </div>

        {# Search Form #}
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <form method="get" action="{{ path('app_offre_index') }}">
                    {# Keep existing sort/page parameters when searching #}
                    {% if pagination.params.sort is defined %}<input type="hidden" name="sort" value="{{ pagination.params.sort }}">{% endif %}
                    {% if pagination.params.direction is defined %}<input type="hidden" name="direction" value="{{ pagination.params.direction }}">{% endif %}

                    <div class="input-group">
                        <input type="search" name="q" class="form-control" placeholder="Search by route, fuel, price..." value="{{ searchTerm }}">
                        <button class="btn btn-outline-secondary" type="submit" title="Search">
                            <i class="fas fa-search"></i>
                        </button>
                        {# Add a reset button if a search term exists #}
                        {% if searchTerm %}
                            <a href="{{ path('app_offre_index', { sort: pagination.params.sort|default(null), direction: pagination.params.direction|default(null) }) }}" class="btn btn-outline-danger" title="Clear Search">
                                <i class="fas fa-times"></i>
                            </a>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>

        <div class="card shadow">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                        <tr>
                            {# Sortable Headers #}
                            <th>{{ knp_pagination_sortable(pagination, 'ID', 'o.idOffre') }}</th>
                            <th>Photo</th>
                            <th>{{ knp_pagination_sortable(pagination, 'Parcour (Route)', 'p.trajet') }}</th>
                            <th>{{ knp_pagination_sortable(pagination, 'Departure', 'o.dateDepart') }}</th>
                            <th>{{ knp_pagination_sortable(pagination, 'Price', 'o.prix') }}</th>
                            <th>{{ knp_pagination_sortable(pagination, 'Seats', 'o.nombrePlaces') }}</th>
                            <th>{{ knp_pagination_sortable(pagination, 'Fuel', 'o.typeFuel') }}</th>
                            <th>{{ knp_pagination_sortable(pagination, 'A/C', 'o.climatisee') }}</th>
                            <th class="text-end">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for offre in pagination %} {# Loop through pagination object #}
                            <tr>
                                <td>{{ offre.idOffre }}</td>
                                <td>
                                    {% if offre.photo %}
                                        {# Use vich_uploader_asset to get the correct public path #}
                                        <img src="{{ vich_uploader_asset(offre, 'photoFile') | imagine_filter('admin_thumb') }}" {# Use LiipImagineBundle filter #}
                                             alt="Photo for Offre #{{ offre.idOffre }}"
                                             style="max-height: 40px; max-width: 60px; object-fit: cover;"
                                             loading="lazy">
                                        {# Fallback if Liip not configured yet:
                                     <img src="{{ vich_uploader_asset(offre, 'photoFile') }}"
                                          alt="Photo for Offre #{{ offre.idOffre }}" height="40">
                                        #}
                                    {% else %}
                                        <span class="text-muted small">No photo</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {# Link to parcour show page? #}
                                    <a href="{{ path('app_parcour_show', {'idParcours': offre.parcour.idParcours}) }}" title="{{ offre.parcour.trajet }}">
                                        {{ offre.parcour.trajet }}
                                    </a>
                                </td>
                                <td>{{ offre.dateDepart ? offre.dateDepart|date('Y-m-d H:i') : 'N/A' }}</td>
                                <td>{{ offre.prix|number_format(2, '.', ',') }} TND</td> {# Format price #}
                                <td class="text-center">{{ offre.nombrePlaces }}</td>
                                <td>{{ offre.typeFuel|capitalize }}</td>
                                <td class="text-center">
                                    {% if offre.climatisee %}
                                        <i class="fas fa-check text-success" title="Yes"></i>
                                    {% else %}
                                        <i class="fas fa-times text-danger" title="No"></i>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <a href="{{ path('app_offre_show', {'idOffre': offre.idOffre}) }}" class="btn btn-info btn-sm" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{{ path('app_offre_edit', {'idOffre': offre.idOffre}) }}" class="btn btn-warning btn-sm" title="Edit Offre">
                                        <i class="fas fa-pencil-alt"></i>
                                    </a>
                                    {# Include the delete form partial #}
                                    {{ include('offre/_delete_form.html.twig', { 'offre': offre }) }}
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                {# Adjust colspan #}
                                <td colspan="9" class="text-center">No offres found matching your criteria.</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div> {# End table-responsive #}
            </div> {# End card-body #}

            {# Display pagination controls #}
            <div class="card-footer bg-white d-flex justify-content-center">
                {{ knp_pagination_render(pagination) }}
            </div>
        </div> {# End card #}

    </div> {# End container-fluid #}
{% endblock %}